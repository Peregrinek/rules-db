name: Distilling wetest.vip variety CDN ips

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cdn branch
        uses: actions/checkout@v4
        with:
          ref: cdn

      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch and Process IP Lists
        run: |
          CDN_LIST=("cloudflare" "cloudfront")
          
          for provider in "${CDN_LIST[@]}"; do
            echo "Processing $provider..."
            
            mkdir -p "$provider"
            
            curl -s -f "https://www.wetest.vip/api/cf2dns/get_${provider}_ip?key=o1zrmHAF&type=v4" \
            | jq -r '.info | to_entries | .[].value[]?.address // empty' | sort -u > "$provider/v4.list"

            curl -s -f "https://www.wetest.vip/api/cf2dns/get_${provider}_ip?key=o1zrmHAF&type=v6" \
            | jq -r '.info | to_entries | .[].value[]?.address // empty' | sort -u > "$provider/v6.list"
          done
          
      - name: Commit and push if changed
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "chore: update CDN IP lists $(date -u +'%Y-%m-%d %H:%M:%S') UTC"
            git push origin cdn
          else
            echo "No changes detected"
          fi
