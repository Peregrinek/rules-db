name: Generate Shadowrocket Rules via MetaCubeX

on:
  schedule:
    - cron: '1 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout shadowrocket branch
        uses: actions/checkout@v4
        with:
          ref: shadowrocket

      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download and convert rule lists
        run: |
          set -e

          BASE_URL="https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite"
          FILES=("cn.list" "openai.list" "apple.list" "paypal.list" "spotify.list")

          for file in "${FILES[@]}"; do
            echo "Processing $file"

            curl -fsSL "$BASE_URL/$file" | \
            awk '
            BEGIN { OFS="" }
            
            /^$/ || /^#/ { next }

            /^\+\./ {
            sub(/^\+\./, "", $0)
            print "DOMAIN-SUFFIX,", $0
            next
            }

            /^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\/[0-9]+$/ {
            print "IP-CIDR,", $0
            next
            }

            /^[0-9a-fA-F:]+\/[0-9]+$/ {
            print "IP-CIDR6,", $0
            next
            }

            {
            print "DOMAIN,", $0
            }

            ' > "$file"
          done
      - name: Commit and push if changed
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "chore: update shadowrocket rule lists $(date -u +'%Y-%m-%d %H:%M:%S') UTC"
            git push origin shadowrocket
          else
            echo "No changes detected"
          fi
