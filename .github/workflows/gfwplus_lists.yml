name: Auto Update GFW List

on:
  issues:
    types: [opened]

jobs:
  process-rule:
    if: contains(github.event.issue.labels.*.name, 'gfwplus')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout bin branch
        uses: actions/checkout@v4
        with:
          ref: bin
          
      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Parse and Format Rule
        id: format
        run: |
          TYPE=$(echo "${{ github.event.issue.body }}" | grep -A 2 "Rule Type" | tail -n 1)
          RAW_CONTENT=$(echo "${{ github.event.issue.body }}" | grep -A 2 "Content" | tail -n 1)
          
          GFW_REMOTE_URL="https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/gfw.list"
          curl -sL "$GFW_REMOTE_URL" -o remote_gfw_raw.list
          sed 's/^\+\.//' remote_gfw_raw.list > remote_domains_only.txt

          echo "Detected Type: $TYPE"
          IFS=',' read -ra ADDR <<< "$RAW_CONTENT"
          
          > processed_rules.txt
          > skipped_rules.txt
          
          for item in "${ADDR[@]}"; do
            CLEAN_ITEM=$(echo "$item" | xargs)
            [ -z "$CLEAN_ITEM" ] && continue

            if [[ "$TYPE" == *"Domain"* ]]; then
              DOMAIN=$(echo "$CLEAN_ITEM" | sed -e 's|^[^/]*//||' -e 's|/.*$||' -e 's|:.*$||')
              
              IS_SKIPPED=false
              TEMP_DOMAIN="$DOMAIN"
              
              while [[ "$TEMP_DOMAIN" == *"."* ]]; do
                if grep -Fxq "$TEMP_DOMAIN" remote_domains_only.txt; then
                  IS_SKIPPED=true
                  break
                fi
                TEMP_DOMAIN=$(echo "$TEMP_DOMAIN" | cut -d'.' -f2-)
              done
              
              if [ "$IS_SKIPPED" = false ] && grep -Fxq "$TEMP_DOMAIN" remote_domains_only.txt; then
                IS_SKIPPED=true
              fi

              if [ "$IS_SKIPPED" = true ]; then
                echo "$DOMAIN (Upper Domain Discovered)" >> skipped_rules.txt
              else
                echo "+.$DOMAIN" >> processed_rules.txt
              fi
            elif [[ "$TYPE" == *"Keyword"* ]]; then
              echo "-$CLEAN_ITEM" >> processed_rules.txt
            fi
          done
          
          echo "clean_content=$RAW_CONTENT" >> $GITHUB_OUTPUT

      - name: Update gfwplus.list
        if: hashFiles('processed_rules.txt') != ''
        run: |
          touch gfwplus.list
          cat processed_rules.txt >> gfwplus.list
          sort -u gfwplus.list -o gfwplus.list

      - name: Commit and Push
        if: hashFiles('processed_rules.txt') != ''
        run: |
          git add gfwplus.list
          
          if git diff --staged --quiet; then
            echo "No changes to gfwplus.list, skipping commit."
          else
            echo "Changes detected, committing..."
            git commit -m "Auto add rules via Issue #${{ github.event.issue.number }}"
            git push origin bin
          fi
          
      - name: Feedback and Close Issue
        if: always()
        run: |
          echo "ðŸš€ **Report on processing results:**" > comment.md
          echo "" >> comment.md
          
          if [ -s processed_rules.txt ]; then
            echo "âœ… **Added to \`gfwplus.list\`:**" >> comment.md
            echo "\`\`\`text" >> comment.md
            cat processed_rules.txt >> comment.md
            echo "\`\`\`" >> comment.md
            echo "" >> comment.md
          fi
          
          if [ -s skipped_rules.txt ]; then
            echo "âš ï¸ **Skipped (duplicate item):**" >> comment.md
            echo "\`\`\`text" >> comment.md
            cat skipped_rules.txt >> comment.md
            echo "\`\`\`" >> comment.md
            echo "" >> comment.md
          fi
          
          if [ ! -s processed_rules.txt ] && [ ! -s skipped_rules.txt ]; then
            echo "âŒ No valid content or format errors detected." >> comment.md
          fi

          gh issue comment ${{ github.event.issue.number }} --body-file comment.md
          gh issue close ${{ github.event.issue.number }} --reason "completed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
