name: Auto Update GFW List
on:
  issues:
    types: [opened]

jobs:
  process-rule:
    if: contains(github.event.issue.labels.*.name, 'gfwplus')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout bin branch
        uses: actions/checkout@v4
        with:
          ref: bin
          
      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Parse and Format Rule
        id: format
        run: |
          TYPE=$(echo "${{ github.event.issue.body }}" | grep -A 2 "Rule Type" | tail -n 1)
          CONTENT=$(echo "${{ github.event.issue.body }}" | grep -A 2 "Content" | tail -n 1 | xargs)

          echo "Detected Type: $TYPE"
          echo "Detected Content: $CONTENT"
          
          if [[ "$TYPE" == *"Domain"* ]]; then
            FINAL_RULE="+.$CONTENT"
          elif [[ "$TYPE" == *"Keyword"* ]]; then
            FINAL_RULE="-$CONTENT"
          else
            echo "Unknown Type"
            exit 1
          fi
          
          echo "final_rule=$FINAL_RULE" >> $GITHUB_OUTPUT
          echo "clean_content=$CONTENT" >> $GITHUB_OUTPUT

      - name: Update gfwplus.list
        run: |
          echo "${{ steps.format.outputs.final_rule }}" >> gfwplus.list
          
          sort -u gfwplus.list -o gfwplus.list
          
          echo "Updated gfwplus.list with: ${{ steps.format.outputs.final_rule }}"

      - name: Commit and Push
        run: |
          git add gfwplus.list
          git commit -m "Auto add ${{ steps.format.outputs.clean_content }} via Issue #${{ github.event.issue.number }}"
          git push origin bin

      - name: Feedback and Close Issue
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ðŸš€ Rule added to \`gfwplus.list\` in branch \`bin\`: \`${{ steps.format.outputs.final_rule }}\`"
          gh issue close ${{ github.event.issue.number }} --reason "completed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
