name: Auto Update GFW List
on:
  issues:
    types: [opened]

jobs:
  process-rule:
    if: contains(github.event.issue.labels.*.name, 'gfwplus')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout bin branch
        uses: actions/checkout@v4
        with:
          ref: bin
          
      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Parse and Format Rule
        id: format
        run: |
          TYPE=$(echo "${{ github.event.issue.body }}" | grep -A 2 "Rule Type" | tail -n 1)
          RAW_CONTENT=$(echo "${{ github.event.issue.body }}" | grep -A 2 "Content" | tail -n 1)

          echo "Detected Type: $TYPE"
          
          IFS=',' read -ra ADDR <<< "$RAW_CONTENT"
          
          > processed_rules.txt
          
          for item in "${ADDR[@]}"; do
            CLEAN_ITEM=$(echo "$item" | xargs)
            
            if [ -n "$CLEAN_ITEM" ]; then
              if [[ "$TYPE" == *"Domain"* ]]; then
                echo "+.$CLEAN_ITEM" >> processed_rules.txt
              elif [[ "$TYPE" == *"Keyword"* ]]; then
                echo "-$CLEAN_ITEM" >> processed_rules.txt
              fi
            fi
          done
          
          echo "rules<<EOF" >> $GITHUB_OUTPUT
          cat processed_rules.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "clean_content=$RAW_CONTENT" >> $GITHUB_OUTPUT

      - name: Update gfwplus.list
        run: |
          touch gfwplus.list

          echo "${{ steps.format.outputs.rules }}" >> gfwplus.list
          
          sort -u gfwplus.list -o gfwplus.list
          
          echo "Updated gfwplus.list with new rules."

      - name: Commit and Push
        run: |
          git add gfwplus.list
          
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto add ${{ steps.format.outputs.clean_content }} via Issue #${{ github.event.issue.number }}" && git push origin bin)

      - name: Feedback and Close Issue
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ðŸš€ Rules added to \`gfwplus.list\` in branch \`bin\`:
          \`\`\`text
          ${{ steps.format.outputs.rules }}
          \`\`\`"
          gh issue close ${{ github.event.issue.number }} --reason "completed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
